{"version":3,"sources":["../src/main.js"],"names":[],"mappings":"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","file":"main.js","sourcesContent":["require(\"babel/polyfill\");\nvar phantom = require('node-slimer');\nvar fs = require('fs');\nvar url = require('url');\nvar ABPFilterParser = require('abp-filter-parser');\nvar slimer;\nlet parsedFilterData = {};\nlet cachedFilterData = {};\n\nvar slimerjs = require('slimerjs')\nvar binPath = slimerjs.path\n\n\nconst startTime = () => process.hrtime();\nconst endTime = (startTime) => {\n  let diff = process.hrtime(startTime);\n  return diff[0] * 1000 + diff[1] / 1000000; // divide by a million to get nano to milli\n}\n\nexport function init(easyListPath) {\n  return new Promise((resolve, reject) => {\n    let easyListTxt = fs.readFileSync(easyListPath, 'utf-8');\n    ABPFilterParser.parse(easyListTxt, parsedFilterData);\n    console.log('Done parsing easylist!');\n    phantom.create((err, sl) => {\n      slimer = sl;\n      if (err) {\n        console.error('init error:', err);\n        reject(err);\n      } else {\n        resolve(slimer);\n      }\n    }, {\n      phantomPath: binPath,\n      parameters: {\n        'load-images': 'false',\n      }\n    });\n  });\n}\n\nexport function exit(exitCode = 0) {\n  slimer.exit();\n  return exitCode;\n}\n\nfunction createPage(urlToNavigate) {\n  return new Promise((resolve, reject) => {\n    slimer.createPage((err, page) => {\n      if (err) {\n        reject(err);\n      } else {\n        // To enable logging:\n        // page.onConsoleMessage = function(msg, lineNum, sourceId) {\n        //    console.log('CONSOLE: ' + msg + ' (from line #' + lineNum + ' in \"' + sourceId + '\")');\n        // };\n        page.pageLoadStartTime = startTime();\n        page.resourcesRequested = 0;\n        page.resourcesBlocked = [];\n        page.abpTime = 0;\n\n        page.onResourceRequested = function(requestData, networkRequest) {\n          page.resourcesRequested++;\n          let urlToCheck = url.parse(requestData[0].url);\n          let currentPageHostname = url.parse(urlToNavigate).hostname;\n\n          let abpTime = startTime();\n          if (ABPFilterParser.matches(parsedFilterData, urlToCheck.href, {\n            domain: currentPageHostname,\n            elementTypeMaskMap: ABPFilterParser.elementTypes.SCRIPT,\n          }, cachedFilterData)) {\n            // console.log('block: ', urlToCheck.href);\n            page.resourcesBlocked.push(urlToCheck.href);\n          } else {\n            // console.log('noblock: ', urlToCheck.href);\n          }\n          page.abpTime += endTime(abpTime);\n\n          //console.log('Request (#' + requestData.id + '): ' + JSON.stringify(requestData));\n        };\n        page.set('settings', {\n          loadImages: false,\n          userAgent: 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.1',\n          webSecurityEnabled: false,\n          resourceTimeout: 60000,\n        }, (err) => {\n          if (err) {\n            console.warn('Could not set page settings', err);\n            reject(err);\n          }\n          resolve(page);\n        });\n      }\n    });\n  });\n}\n\nfunction waitForReadyState(page) {\n  return new Promise((resolve, reject) => {\n    let elapsed = 0;\n    let intervalLength = 1000;\n    let maxWaitTime = 15000;\n    let intervalId = setInterval(function() {\n      page.evaluate(function () {\n        return document.readyState;\n      }, function(err, readyState) {\n        if (err) {\n          console.error('err on waitForReadyState:', err);\n          page.close();\n          reject(err);\n        }\n        console.log('ready state update err', err, 'readystate', readyState);\n        elapsed += intervalLength;\n        if (elapsed > maxWaitTime || readyState === 'complete') {\n          clearInterval(intervalId);\n          resolve(page);\n        }\n      });\n    }, intervalLength);\n  });\n}\n\nfunction navigate(urlToNavigate) {\n  return new Promise((resolve, reject) => {\n    createPage(urlToNavigate).then(page => {\n      page.open(urlToNavigate, function (err, status) {\n        if (err) {\n          page.close();\n          reject(err);\n        } else if (status === 'timeout') {\n          page.close();\n          reject('Timeout');\n        } else {\n          resolve(page);\n        }\n      });\n    }).catch(err => {\n      console.error('create page err:', err);\n      reject(err);\n    });\n  });\n}\n\nfunction extractIframes(page) {\n  return new Promise((resolve, reject) => {\n    page.evaluate(function () {\n      function isSupportedAdSize(width, height) {\n        return width === 728 && height === 90 ||\n          width === 300 && height === 250 ||\n          width === 160 && height === 600 ||\n          width === 320 && height === 50;\n      }\n\n      function getElementContentWidth(element) {\n        var styles = window.getComputedStyle(element);\n        var padding = parseFloat(styles.paddingLeft) +\n          parseFloat(styles.paddingRight);\n        return element.clientWidth - padding;\n      }\n      function getElementContentHeight(element) {\n        var styles = window.getComputedStyle(element);\n        var padding = parseFloat(styles.paddingTop) +\n          parseFloat(styles.paddingBottom);\n        return element.clientHeight - padding;\n      }\n\n      // Gets the top most parent ID with the same dimensions as the\n      // passed in node\n      function getReplaceId(node, width, height) {\n        if (!node.parentNode) {\n          return node;\n        }\n\n        if (!node.parentNode.id) {\n          return node;\n        }\n\n        var parentWidth = getElementContentWidth(node.parentNode);\n        var parentHeight = getElementContentHeight(node.parentNode);\n\n        // TODO: Check against abp-filter html rules instead\n        var gptPlaceholder = node.parentNode.id.indexOf('gpt-ad-') !== -1;\n        if (!gptPlaceholder && (parentWidth > width || parentHeight > height) &&\n            // Single child parent which is close to the same size should be considered as replacement target\n            (node.parentNode.children.length !== 1 || parentHeight - height > 100 || parentWidth - width > 100)) {\n          return node;\n        }\n\n        return getReplaceId(node.parentNode, width, height);\n      }\n\n      var iframes = document.querySelectorAll('iframe');\n      var iframesData = [];\n      for (var i = 0; i < iframes.length; i++) {\n        var iframe = iframes[i];\n        var width = getElementContentWidth(iframe);\n        var height = getElementContentHeight(iframe);\n        if (isSupportedAdSize(width, height)) {\n          iframesData.push({\n            //src: iframe.src,\n            width: width,\n            height: height,\n            //top: rect.top,\n            //left: rect.left,\n            //name: iframe.name,\n            //id: iframe.id,\n            replaceId: getReplaceId(iframe, width, height).id,\n          });\n        }\n      }\n      return iframesData;\n    }, function(err, iframesData) {\n      page.close();\n      if (err) {\n        reject(err);\n      } else {\n        resolve({\n          numResourcesRequested: page.resourcesRequested,\n          numResourcesBlocked: page.resourcesBlocked.length,\n          resourcesBlocked: page.resourcesBlocked,\n          abpTime: page.abpTime,\n          pageLoadTime: endTime(page.pageLoadStartTime),\n          bloomNegativeCount: cachedFilterData.bloomNegativeCount,\n          bloomPositiveCount: cachedFilterData.bloomPositiveCount,\n          notMatchCount: cachedFilterData.notMatchCount,\n          bloomFalsePositiveCount: cachedFilterData.bloomFalsePositiveCount,\n          badFingerprints: cachedFilterData.badFingerprints,\n          iframesData\n        });\n      }\n    });\n  });\n}\n\nexport function getAdInfo(urlToCheck) {\n  return new Promise((resolve, reject) => {\n    navigate(urlToCheck)\n      .then(waitForReadyState)\n      .then(extractIframes)\n      .then(resolve)\n      .catch(reject);\n  });\n}\n"]}